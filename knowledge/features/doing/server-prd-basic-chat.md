# 服务端功能：基础IM聊天系统

## 1. 功能概述
- **功能描述**：为局域网IM聊天应用提供实时消息服务、用户管理和数据持久化的完整后端支持
- **服务对象**：Electron桌面客户端，支持局域网内多用户同时在线聊天
- **业务价值**：建立稳定可靠的实时通信基础设施，为后续音视频通话等高级功能奠定基础

## 2. 需求背景
- **业务背景**：需要在局域网环境下建立一个无需复杂注册流程的IM聊天系统，用户仅需输入用户名即可开始聊天
- **现有痛点**：缺乏专门的局域网聊天解决方案，现有方案要么过于复杂需要注册认证，要么功能过于简单无法满足团队协作需求
- **解决方案**：构建轻量级、高性能的WebSocket服务端，提供实时消息转发、用户状态管理和基础数据存储功能

## 3. API接口设计

### 3.1 核心API端点

#### REST API接口
- **路径**：GET /api/health
  - **功能描述**：系统健康检查接口
  - **请求参数**：无
  - **响应格式**：`{"status": "ok", "timestamp": "2025-01-XX", "uptime": 3600, "connections": 5}`
  - **错误处理**：500 - 服务内部错误

- **路径**：GET /api/messages
  - **功能描述**：获取历史消息记录
  - **请求参数**：`?limit=50&before=timestamp`
  - **响应格式**：`{"messages": [Message], "hasMore": boolean}`
  - **错误处理**：400 - 参数错误，500 - 数据库错误

- **路径**：POST /api/upload
  - **功能描述**：文件上传接口（后续阶段）
  - **请求参数**：multipart/form-data文件
  - **响应格式**：`{"fileUrl": "string", "fileName": "string", "fileSize": number}`
  - **错误处理**：413 - 文件过大，415 - 文件类型不支持

- **路径**：GET /api/files/:filename
  - **功能描述**：文件下载接口
  - **请求参数**：filename路径参数
  - **响应格式**：文件流
  - **错误处理**：404 - 文件不存在，403 - 访问拒绝

#### WebSocket事件API
- **user:join** - 用户加入聊天室
  - **请求数据**：`{username: string}`
  - **响应事件**：`user:joined`, `users:update`
  - **错误处理**：用户名重复时发送错误事件

- **message:send** - 发送消息
  - **请求数据**：`{type: 'text', content: string, timestamp: number}`
  - **响应事件**：`message:received`（广播给所有用户）
  - **错误处理**：消息过长或格式错误时发送错误事件

- **user:leave** - 用户离开（断开连接）
  - **触发条件**：WebSocket连接断开
  - **响应事件**：`user:left`, `users:update`

### 3.2 认证和授权
- **认证方式**：基于Socket.io会话的简单认证，无需JWT
- **权限控制**：所有连接用户具有相同权限，可发送和接收消息
- **安全验证**：用户名唯一性检查，消息内容长度限制

### 3.3 数据验证
- **输入验证**：
  - 用户名：1-20字符，不能包含特殊字符
  - 消息内容：最大1000字符
  - 文件大小：最大10MB
- **业务规则验证**：用户名唯一性检查，在线用户数量限制
- **数据格式标准**：统一使用JSON格式，时间戳使用Unix timestamp

## 4. 数据库设计

### 4.1 数据模型

#### User表
```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  username TEXT UNIQUE NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  last_seen DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### Message表
```sql
CREATE TABLE messages (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL CHECK(type IN ('text', 'file', 'system')),
  content TEXT NOT NULL,
  sender_id TEXT NOT NULL,
  timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
  file_path TEXT,
  file_name TEXT,
  file_size INTEGER,
  FOREIGN KEY (sender_id) REFERENCES users (id)
);
```

#### OnlineUsers表（内存存储）
```sql
CREATE TABLE online_users (
  socket_id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  username TEXT NOT NULL,
  joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users (id)
);
```

### 4.2 数据库性能
- **索引设计**：
  - `messages.timestamp` - 用于消息历史查询
  - `users.username` - 用于用户名唯一性检查
  - `online_users.user_id` - 用于在线用户查询
- **查询优化**：消息历史分页查询，限制单次查询数量
- **数据分片**：暂不需要，单机SQLite足够支持

### 4.3 数据一致性
- **事务处理**：用户加入和消息存储使用事务确保一致性
- **并发控制**：SQLite提供基础并发控制，避免写冲突
- **数据同步**：通过Socket.io事件确保所有客户端状态同步

## 5. 业务逻辑实现

### 5.1 核心业务流程

1. **用户连接流程**：
   - 客户端建立WebSocket连接
   - 发送用户名进行身份验证
   - 服务端检查用户名唯一性
   - 创建或更新用户记录
   - 添加到在线用户列表
   - 广播用户加入事件和更新用户列表

2. **消息发送流程**：
   - 接收客户端消息数据
   - 验证消息格式和内容
   - 存储消息到数据库
   - 广播消息给所有在线用户
   - 记录发送日志

3. **用户离开流程**：
   - 检测WebSocket连接断开
   - 从在线用户列表移除
   - 更新用户最后在线时间
   - 广播用户离开事件和更新用户列表

### 5.2 异常处理策略
- **系统异常**：数据库连接失败时降级为内存存储，记录错误日志
- **业务异常**：用户名重复、消息格式错误等通过Socket事件返回错误信息
- **外部服务异常**：暂无外部服务依赖

### 5.3 业务规则
- **验证规则**：用户名长度1-20字符，消息内容最大1000字符
- **计算规则**：在线用户数统计，消息历史分页计算
- **状态转换**：用户状态（离线→在线→离线），消息状态（发送中→已发送）

## 6. 技术要求

### 6.1 性能要求
- **响应时间**：消息转发延迟 < 100ms（局域网环境）
- **吞吐量**：支持至少50个并发用户，100条/秒消息处理
- **数据容量**：支持10万条历史消息，1000个用户记录

### 6.2 可扩展性要求
- **横向扩展**：当前为单实例部署，预留集群扩展接口
- **负载均衡**：暂不需要，单机处理能力足够
- **缓存策略**：在线用户列表使用内存缓存，消息历史使用简单缓存

### 6.3 安全要求
- **数据加密**：WebSocket使用WSS（可选），本地数据库文件权限控制
- **访问控制**：基于IP的访问控制（局域网），简单的频率限制
- **审计日志**：记录用户加入离开、消息发送等关键操作
- **合规要求**：符合内部网络安全规范

## 7. 外部依赖

### 7.1 第三方服务
- **服务名称**：无外部第三方服务依赖
- **集成方式**：纯本地部署
- **降级策略**：不适用

### 7.2 数据库依赖
- **数据库类型**：SQLite 3.40+
- **版本要求**：与Node.js sqlite3驱动兼容
- **连接池配置**：单连接，支持并发读取

### 7.3 基础设施
- **服务器要求**：最低2GB内存，1核CPU，10GB存储空间
- **网络要求**：局域网连接，支持WebSocket协议
- **监控需求**：基础的进程监控和日志记录

## 8. 测试策略

### 8.1 单元测试
- **覆盖率要求**：核心业务逻辑覆盖率 >= 80%
- **核心测试点**：用户管理服务、消息处理服务、数据库操作
- **Mock策略**：Mock Socket.io连接和数据库操作

### 8.2 集成测试
- **API测试**：所有REST API和WebSocket事件的功能测试
- **数据库测试**：数据CRUD操作和并发访问测试
- **服务间测试**：WebSocket服务与数据库的集成测试

### 8.3 压力测试
- **负载测试**：50并发用户，每用户每秒1条消息
- **压力测试**：100并发连接建立和断开
- **容错测试**：数据库连接失败、内存不足等场景测试

## 9. 部署和运维

### 9.1 部署要求
- **容器化**：Docker镜像，包含Node.js运行时和应用代码
- **环境配置**：开发、测试、生产环境的配置文件分离
- **配置管理**：使用环境变量管理端口、数据库路径等配置

### 9.2 监控和日志
- **性能监控**：CPU、内存使用率，WebSocket连接数
- **错误监控**：异常堆栈跟踪，错误频率统计
- **业务监控**：在线用户数，消息发送量，数据库操作耗时
- **日志策略**：分级日志（info/warn/error），日志轮转，最多保留7天

### 9.3 维护和更新
- **版本管理**：语义化版本号，向后兼容的API设计
- **数据迁移**：SQLite schema变更的迁移脚本
- **回滚策略**：保留前一版本的Docker镜像，快速回滚机制

## 10. 验收标准

### 10.1 功能验收
- [ ] WebSocket连接建立和断开正常
- [ ] 用户加入、离开事件正确处理
- [ ] 消息发送、接收、存储功能正常
- [ ] 历史消息查询功能正确
- [ ] 在线用户列表实时更新
- [ ] 用户名唯一性验证有效
- [ ] 系统消息（用户进出）正常显示

### 10.2 性能验收
- [ ] 消息转发延迟 < 100ms
- [ ] 支持50个并发用户稳定运行
- [ ] 数据库查询响应时间 < 50ms
- [ ] 内存使用 < 512MB（50用户场景）
- [ ] 长时间运行稳定（24小时+）

### 10.3 安全验收
- [ ] 输入数据验证完整有效
- [ ] 无SQL注入漏洞
- [ ] 频率限制机制有效
- [ ] 错误信息不泄露敏感数据

### 10.4 可维护性验收
- [ ] 代码结构清晰，模块化良好
- [ ] 日志记录完整，便于问题排查
- [ ] 配置文件管理规范
- [ ] 文档完整，部署流程清晰

---

**备注**：此PRD为Phase 1基础聊天功能的服务端实现规范，后续Phase 2将添加文件传输、群组功能，Phase 3将添加音视频通话的信令服务支持。